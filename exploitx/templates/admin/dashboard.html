{% set admin_panel = True %}
{% extends "base.html" %}

{% block title %}Admin Dashboard | ExploitX CTF Team{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="admin-page">
    <div class="admin-container">
        <aside class="admin-sidebar">
            <nav class="admin-nav">
                <ul>
                    <li><a href="{{ url_for('admin_dashboard') }}" class="active">Dashboard</a></li>
                    <li><a href="{{ url_for('admin_contacts') }}">Contact Messages</a></li>
                    <li><a href="{{ url_for('admin_applications') }}">Team Applications</a></li>
                    <li><a href="{{ url_for('add_event') }}">Add Event</a></li>
                    <li><a href="{{ url_for('add_team_member') }}">Add Team Member</a></li>
                    <li><a href="{{ url_for('add_user') }}">Add User</a></li>
                    <li><a href="{{ url_for('edit_contact_info') }}">Edit Contact Info</a></li>
                    <li><a href="{{ url_for('admin_logout') }}">Logout</a></li>
                </ul>
            </nav>
        </aside>

        <main class="admin-content">
            <header class="admin-header">
                <h1>Admin Dashboard</h1>
                <div class="admin-header-actions">
                    <span>Welcome, {{ current_user.username }}</span>
                </div>
            </header>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="admin-grid">
                <!-- Quick Stats -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">Quick Stats</h3>
                    </div>
                    <div class="admin-stats">
                        <div class="stat-item">
                            <div class="number">{{ events|length }}</div>
                            <div class="label">Events</div>
                        </div>
                        <div class="stat-item">
                            <div class="number">{{ members|length }}</div>
                            <div class="label">Team Members</div>
                        </div>
                        <div class="stat-item">
                            <div class="number">{{ users|length }}</div>
                            <div class="label">Users</div>
                        </div>
                        <div class="stat-item">
                            <div class="number">{{ new_messages_count }}</div>
                            <div class="label">New Messages</div>
                        </div>
                    </div>
                </div>

                <!-- Contact Information -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">Contact Information</h3>
                        <a href="{{ url_for('edit_contact_info') }}" class="admin-btn">Edit Contact Info</a>
                    </div>
                    <div class="contact-info">
                        {% if contact_info %}
                        <div class="info-item">
                            <i class="fas fa-phone"></i>
                            <span>{{ contact_info.phone }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-envelope"></i>
                            <span>{{ contact_info.email }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>{{ contact_info.location }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-clock"></i>
                            <span>{{ contact_info.office_hours }}</span>
                        </div>
                        {% else %}
                        <p class="no-info">No contact information set. <a href="{{ url_for('edit_contact_info') }}">Add contact information</a></p>
                        {% endif %}
                    </div>
                </div>

                <!-- Contact Messages -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">Contact Messages</h3>
                        <a href="{{ url_for('admin_contacts') }}" class="admin-btn">View All Messages</a>
                    </div>
                    <div class="admin-list">
                        {% for contact in recent_messages %}
                        <div class="admin-list-item {% if not contact.is_read %}unread{% endif %}">
                            <div class="item-info">
                                <h4>{{ contact.subject }}</h4>
                                <p class="meta">
                                    From: {{ contact.full_name }}
                                    <br>
                                    {{ contact.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    {% if not contact.is_read %}
                                    <span class="badge">New</span>
                                    {% endif %}
                                </p>
                            </div>
                            <div class="item-actions">
                                <a href="{{ url_for('view_contact', id=contact.id) }}" class="admin-btn">View</a>
                            </div>
                        </div>
                        {% else %}
                        <div class="no-items">
                            <p>No contact messages yet.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Team Applications -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">Team Applications</h3>
                        <a href="{{ url_for('admin_applications') }}" class="admin-btn">View All Applications</a>
                    </div>
                    <div class="admin-list">
                        {% for application in recent_applications %}
                        <div class="admin-list-item {% if application.status == 'pending' %}unread{% endif %}">
                            <div class="item-info">
                                <h4>{{ application.full_name }}</h4>
                                <p class="meta">
                                    Role: {{ application.role }}
                                    <br>
                                    Applied: {{ application.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    <span class="badge {% if application.status == 'pending' %}badge-warning{% elif application.status == 'approved' %}badge-success{% else %}badge-danger{% endif %}">
                                        {{ application.status|title }}
                                    </span>
                                </p>
                            </div>
                            <div class="item-actions">
                                <a href="{{ url_for('view_application', id=application.id) }}" class="admin-btn">View</a>
                            </div>
                        </div>
                        {% else %}
                        <div class="no-items">
                            <p>No team applications yet.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Events Management -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">Events Management</h3>
                        <a href="{{ url_for('add_event') }}" class="admin-btn">Add New Event</a>
                    </div>
                    <div class="admin-list">
                        {% for event in events %}
                        <div class="admin-list-item">
                            <div class="item-info">
                                <h4>{{ event.title }}</h4>
                                <p>{{ event.date.strftime('%B %d, %Y %H:%M') }}</p>
                                <p class="location">{{ event.location }}</p>
                            </div>
                            <div class="item-actions">
                                <a href="{{ url_for('edit_event', id=event.id) }}" class="admin-btn">Edit</a>
                                <form action="{{ url_for('delete_event', id=event.id) }}" method="POST" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this event?');">
                                    <button type="submit" class="admin-btn danger">Delete</button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Team Management -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">Team Management</h3>
                        <a href="{{ url_for('add_team_member') }}" class="admin-btn">Add New Member</a>
                    </div>
                    <div class="admin-list">
                        {% for member in members %}
                        <div class="admin-list-item">
                            <div class="item-info">
                                <h4>{{ member.name }}</h4>
                                <p class="role">{{ member.role }}</p>
                                <p class="bio">{{ member.bio[:100] }}{% if member.bio|length > 100 %}...{% endif %}</p>
                            </div>
                            <div class="item-actions">
                                <a href="{{ url_for('edit_team_member', id=member.id) }}" class="admin-btn">Edit</a>
                                <form action="{{ url_for('delete_team_member', id=member.id) }}" method="POST" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this team member?');">
                                    <button type="submit" class="admin-btn danger">Delete</button>
                                </form>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- User Management -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3 class="admin-card-title">User Management</h3>
                        <a href="{{ url_for('add_user') }}" class="admin-btn">Add New User</a>
                    </div>
                    <div class="admin-list">
                        {% for user in users %}
                        <div class="admin-list-item">
                            <div class="item-info">
                                <h4>{{ user.username }}</h4>
                                <p class="role">
                                    {% if user.is_super_admin %}
                                        Super Admin
                                    {% elif user.is_admin %}
                                        Admin
                                    {% else %}
                                        User
                                    {% endif %}
                                </p>
                                {% if user.is_super_admin %}
                                <span class="badge badge-success">Super Admin</span>
                                {% endif %}
                            </div>
                            <div class="item-actions">
                                {# EDIT BUTTON LOGIC #}
                                {% if current_user.id == user.id %}
                                    {# User can always edit their own profile #}
                                    <a href="{{ url_for('edit_user', user_id=user.id) }}" class="admin-btn">Edit Profile</a>
                                {% elif current_user.is_super_admin %}
                                    {# Super admin can edit any user #}
                                    <a href="{{ url_for('edit_user', user_id=user.id) }}" class="admin-btn">Edit</a>
                                {% elif current_user.is_admin and not user.is_admin and not user.is_super_admin %}
                                    {# Regular admin can edit regular users only #}
                                        <a href="{{ url_for('edit_user', user_id=user.id) }}" class="admin-btn">Edit</a>
                                {% endif %}
                                
                                {# DELETE BUTTON LOGIC #}
                                {% if current_user.id != user.id %}
                                    {% if current_user.is_super_admin and not user.is_super_admin %}
                                        {# Super admin can delete anyone except other super admins #}
                                        <form action="{{ url_for('delete_user', id=user.id) }}" method="POST" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this user?');">
                                            <button type="submit" class="admin-btn danger">Delete</button>
                                        </form>
                                    {% elif current_user.is_admin and not user.is_admin and not user.is_super_admin %}
                                        {# Regular admin can delete regular users only #}
                                <form action="{{ url_for('delete_user', id=user.id) }}" method="POST" class="delete-form" onsubmit="return confirm('Are you sure you want to delete this user?');">
                                    <button type="submit" class="admin-btn danger">Delete</button>
                                </form>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>
{% endblock %}